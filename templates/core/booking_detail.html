{% extends 'base.html' %}

{% block title %}Booking Details - Legal Platform{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto ">
        <div class="card bg-base-100 shadow-2xl ">
            <div class="card-body">
                <!-- Header with status -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="card-title text-2xl">Booking Details</h2>
                    <!-- HTMX polling for real-time status updates -->
                    <div hx-get="{% url 'booking_status' booking.id %}" 
                         hx-trigger="every 10s"
                         hx-swap="innerHTML">
                        {% if booking.status == 'completed' %}
                            <span class="badge badge-success badge-lg gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Completed
                            </span>
                        {% elif booking.status == 'pending' %}
                            <span class="badge badge-warning badge-lg gap-2 animate-pulse">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Pending
                            </span>
                        {% elif booking.status == 'accepted' %}
                            <span class="badge badge-info badge-lg gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Accepted
                            </span>
                        {% elif booking.status == 'in-progress' %}
                            <span class="badge badge-primary badge-lg gap-2 animate-pulse">
                                <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                In Progress
                            </span>
                        {% else %}
                            <span class="badge badge-error badge-lg">{{ booking.status }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Booking Info -->
                <div class="divide-y divide-base-200">
                    <div class="flex justify-between py-4">
                        <span class="opacity-60">Booking ID</span>
                        <span class="font-mono font-medium">{{ booking.id }}</span>
                    </div>
                    <div class="flex justify-between py-4">
                        <span class="opacity-60">Provider</span>
                        <div class="flex items-center gap-2">
                            <div class="avatar placeholder">
                                <div class="w-8 bg-primary text-primary-content rounded-full">
                                    <span class="text-xs">{{ booking.provider.user.get_full_name|slice:":1" }}</span>
                                </div>
                            </div>
                            <span class="font-medium">{{ booking.provider.user.get_full_name }}</span>
                        </div>
                    </div>
                    <div class="flex justify-between py-4">
                        <span class="opacity-60">Service</span>
                        <span class="badge badge-outline">{{ booking.service.title|default:"Consultation" }}</span>
                    </div>
                    <div class="flex justify-between py-4">
                        <span class="opacity-60">Scheduled</span>
                        <span class="font-medium">{{ booking.scheduled_at|date:"F j, Y g:i A" }}</span>
                    </div>
                    <div class="flex justify-between py-4">
                        <span class="opacity-60">Amount</span>
                        <span class="text-lg font-bold text-primary">â‚¹{{ booking.amount }}</span>
                    </div>
                    <div class="flex justify-between py-4">
                        <span class="opacity-60">Payment</span>
                        <div class="flex items-center gap-2">
                            {% if booking.escrow_status == 'held' %}
                                <span class="badge badge-success badge-sm">ðŸ”’ In Escrow</span>
                            {% elif booking.escrow_status == 'released' %}
                                <span class="badge badge-info badge-sm">âœ“ Released</span>
                            {% else %}
                                <span class="badge badge-neutral badge-sm">{{ booking.escrow_status }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Progress Steps -->
                <div class="mt-8">
                    <ul class="steps steps-vertical lg:steps-horizontal w-full">
                        <li class="step {% if booking.status in 'pending,accepted,in-progress,completed' %}step-primary{% endif %}">Booked</li>
                        <li class="step {% if booking.status in 'accepted,in-progress,completed' %}step-primary{% endif %}">Accepted</li>
                        <li class="step {% if booking.status in 'in-progress,completed' %}step-primary{% endif %}">In Progress</li>
                        <li class="step {% if booking.status == 'completed' %}step-primary{% endif %}">Completed</li>
                    </ul>
                </div>
                
                <!-- Consultation Type Info -->
                <div class="flex justify-between py-4 border-t border-base-200">
                    <span class="opacity-60">Consultation Type</span>
                    <span class="badge badge-primary capitalize">
                        {% if booking.consultation_type == 'video' %}
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                        {% elif booking.consultation_type == 'audio' %}
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                        {% elif booking.consultation_type == 'chat' %}
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        {% elif booking.consultation_type == 'in_person' %}
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        {% endif %}
                        {{ booking.consultation_type|default:"video" }}
                    </span>
                </div>

                <!-- Action Buttons -->
                <div class="card-actions mt-8 flex-col sm:flex-row gap-3">
                    <a href="{% url 'citizen_dashboard' %}" class="btn btn-outline flex-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back to Dashboard
                    </a>
                    
                    {% if booking.status == 'accepted' or booking.status == 'confirmed' or booking.status == 'in-progress' %}
                        {% if booking.consultation_type == 'video' %}
                        <a href="{% url 'video_room' booking.id %}" class="btn btn-primary flex-1 gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            Join Video Call
                        </a>
                        {% elif booking.consultation_type == 'audio' %}
                        <a href="{% url 'video_room' booking.id %}" class="btn btn-primary flex-1 gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                            Join Audio Call
                        </a>
                        {% elif booking.consultation_type == 'chat' %}
                        <a href="{% url 'chat_room' booking.id %}" class="btn btn-primary flex-1 gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            Start Chat
                        </a>
                        {% elif booking.consultation_type == 'in_person' %}
                        <div class="alert alert-info flex-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            <span>In-Person Meeting - Contact provider for location details</span>
                        </div>
                        {% else %}
                        <a href="{% url 'video_room' booking.id %}" class="btn btn-primary flex-1 gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            Join Session
                        </a>
                        {% endif %}
                    {% endif %}
                    
                    {% if booking.status == 'pending' or booking.status == 'payment_pending' %}
                    <button class="btn btn-error flex-1 gap-2"
                            hx-post="{% url 'cancel_booking' booking.id %}"
                            hx-confirm="Are you sure you want to cancel this booking?"
                            hx-target="closest .card"
                            hx-swap="outerHTML">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        Cancel Booking
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
