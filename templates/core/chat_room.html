{% extends 'base.html' %}

{% block title %}Chat - {{ other_user.get_full_name }} - Legal Platform{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    .message {
        max-width: 70%;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
    }
    .message-sent {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
    }
    .message-received {
        background: #f3f4f6;
        color: #1f2937;
        border-bottom-left-radius: 0.25rem;
    }
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 0.5rem;
    }
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: bounce 1.4s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
    .status-sent { color: #9ca3af; }
    .status-delivered { color: #6366f1; }
    .status-read { color: #10b981; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-t-2xl shadow-sm p-4 border-b flex items-center gap-4">
            <a href="{% url 'citizen_dashboard' %}" class="text-gray-500 hover:text-gray-700">
                ← Back
            </a>
            <div class="flex-1">
                <h2 class="font-semibold text-gray-900">{{ other_user.get_full_name }}</h2>
                <p class="text-sm text-gray-500" id="user-status">Online</p>
            </div>
            <div id="typing-indicator" class="hidden typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
        
        <!-- Chat Container -->
        <div class="bg-white shadow-sm chat-container" id="chat-container">
            <div class="messages-container" id="messages">
                {% for msg in messages %}
                <div class="message {% if msg.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                    <p>{{ msg.content }}</p>
                    <div class="flex items-center justify-end gap-2 mt-1">
                        <span class="text-xs opacity-70">{{ msg.created_at|time:"H:i" }}</span>
                        {% if msg.sender == request.user %}
                        <span class="text-xs status-{{ msg.status }}">
                            {% if msg.status == 'sent' %}✓{% elif msg.status == 'delivered' %}✓✓{% else %}✓✓{% endif %}
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Input -->
            <div class="p-4 border-t bg-gray-50">
                <form id="chat-form" class="flex gap-3">
                    <input type="text" 
                           id="message-input" 
                           placeholder="Type a message..." class="flex-1 px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-primary-500"
                           autocomplete="off">
                    <button type="submit" class="px-6 py-3 bg-primary-600 text-white rounded-full font-medium hover:bg-primary-700 transition">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const roomId = '{{ room_id }}';
const currentUserId = '{{ request.user.id }}';
const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
let chatSocket = null;
let typingTimeout = null;

function connectWebSocket() {
    chatSocket = new WebSocket(`${wsProtocol}//${window.location.host}/ws/chat/${roomId}/`);
    
    chatSocket.onopen = function(e) {
        console.log('Chat connected');
        document.getElementById('user-status').textContent = 'Online';
    };
    
    chatSocket.onclose = function(e) {
        console.log('Chat disconnected, reconnecting...');
        document.getElementById('user-status').textContent = 'Reconnecting...';
        setTimeout(connectWebSocket, 3000);
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        switch(data.type) {
            case 'message':
                appendMessage(data);
                // Mark as read if from other user
                if (data.sender_id !== currentUserId) {
                    markAsRead(data.message_id);
                }
                break;
            case 'typing':
                if (data.user_id !== currentUserId) {
                    toggleTypingIndicator(data.is_typing);
                }
                break;
            case 'read':
                updateMessageStatus(data.message_id, 'read');
                break;
            case 'user_joined':
                document.getElementById('user-status').textContent = 'Online';
                break;
            case 'user_left':
                document.getElementById('user-status').textContent = 'Offline';
                break;
        }
    };
}

function appendMessage(data) {
    const messagesDiv = document.getElementById('messages');
    const isSent = data.sender_id === currentUserId;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
    messageDiv.dataset.messageId = data.message_id;
    
    const time = new Date(data.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <p>${escapeHtml(data.content)}</p>
        <div class="flex items-center justify-end gap-2 mt-1">
            <span class="text-xs opacity-70">${time}</span>
            ${isSent ? `<span class="text-xs status-${data.status}">✓</span>` : ''}
        </div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function toggleTypingIndicator(isTyping) {
    const indicator = document.getElementById('typing-indicator');
    indicator.classList.toggle('hidden', !isTyping);
}

function updateMessageStatus(messageId, status) {
    const msg = document.querySelector(`[data-message-id="${messageId}"] .status-sent, [data-message-id="${messageId}"] .status-delivered`);
    if (msg) {
        msg.className = `text-xs status-${status}`;
        msg.textContent = status === 'read' ? '✓✓' : '✓✓';
    }
}

function markAsRead(messageId) {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            type: 'read',
            message_id: messageId
        }));
    }
}

function sendTypingIndicator(isTyping) {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            type: 'typing',
            is_typing: isTyping
        }));
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Event listeners
document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            type: 'message',
            content: message
        }));
        input.value = '';
        sendTypingIndicator(false);
    }
});

document.getElementById('message-input').addEventListener('input', function() {
    sendTypingIndicator(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => sendTypingIndicator(false), 2000);
});

// Connect on load
connectWebSocket();

// Scroll to bottom
document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
</script>
{% endblock %}
