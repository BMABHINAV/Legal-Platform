{% extends 'base.html' %}
{% load i18n %}
{% load multilingual %}

{% block title %}{% trans "Legal Emergency" %} - {% trans "Panic Button" %} - {% trans "Legal Platform" %}{% endblock %}

{% block extra_css %}
<style>
    .emergency-bg {
        background: radial-gradient(ellipse at top, #fef2f2 0%, #ffffff 50%, #f8fafc 100%);
    }
    .panic-button {
        width: 220px;
        height: 220px;
        border-radius: 50%;
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #991b1b 100%);
        border: 8px solid rgba(255,255,255,0.3);
        color: white;
        font-size: 1.25rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 
            0 0 0 0 rgba(220, 38, 38, 0.7),
            0 20px 60px rgba(220, 38, 38, 0.4),
            inset 0 -8px 20px rgba(0,0,0,0.2),
            inset 0 8px 20px rgba(255,255,255,0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        position: relative;
    }
    .panic-button::before {
        content: '';
        position: absolute;
        inset: -20px;
        border-radius: 50%;
        border: 2px solid rgba(220, 38, 38, 0.3);
        animation: ripple 2s ease-out infinite;
    }
    .panic-button::after {
        content: '';
        position: absolute;
        inset: -40px;
        border-radius: 50%;
        border: 2px solid rgba(220, 38, 38, 0.2);
        animation: ripple 2s ease-out infinite 0.5s;
    }
    @keyframes ripple {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.3); opacity: 0; }
    }
    .panic-button:hover {
        transform: scale(1.08);
        box-shadow: 
            0 0 0 0 rgba(220, 38, 38, 0.7),
            0 25px 70px rgba(220, 38, 38, 0.5),
            inset 0 -8px 20px rgba(0,0,0,0.2),
            inset 0 8px 20px rgba(255,255,255,0.2);
    }
    .panic-button:active {
        transform: scale(0.95);
    }
    .panic-button.pressed {
        animation: none;
        background: linear-gradient(135deg, #059669 0%, #047857 50%, #065f46 100%);
        box-shadow: 
            0 20px 60px rgba(5, 150, 105, 0.4),
            inset 0 -8px 20px rgba(0,0,0,0.2),
            inset 0 8px 20px rgba(255,255,255,0.2);
    }
    .panic-button.pressed::before,
    .panic-button.pressed::after {
        border-color: rgba(5, 150, 105, 0.3);
    }
    @keyframes pulse-ring {
        0%, 100% { 
            box-shadow: 
                0 0 0 0 rgba(220, 38, 38, 0.7),
                0 20px 60px rgba(220, 38, 38, 0.4),
                inset 0 -8px 20px rgba(0,0,0,0.2),
                inset 0 8px 20px rgba(255,255,255,0.2);
        }
        50% { 
            box-shadow: 
                0 0 0 15px rgba(220, 38, 38, 0),
                0 25px 70px rgba(220, 38, 38, 0.5),
                inset 0 -8px 20px rgba(0,0,0,0.2),
                inset 0 8px 20px rgba(255,255,255,0.2);
        }
    }
    .responder-card {
        animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen emergency-bg py-12">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-2xl mx-auto text-center">
            <!-- Header -->
            <div class="mb-12">
                <div class="inline-flex items-center gap-3 px-5 py-2.5 bg-red-100 text-red-700 rounded-full text-sm font-bold mb-6 shadow-sm   ">
                    <span class="text-xl">üö®</span>
                    <span class="translatable" data-translate="Emergency Legal Help">{% trans "Emergency Legal Help" %}</span>
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
                    <span class="translatable" data-translate="Legal">{% trans "Legal" %}</span> <span class="text-red-600 translatable" data-translate="Emergency">{% trans "Emergency" %}</span>
                </h1>
                <p class="text-lg text-gray-600 max-w-lg mx-auto translatable" data-translate="Press the button below in case of unlawful detention, raids, or any legal emergency. Nearby criminal defense lawyers will be alerted immediately.">
                    {% trans "Press the button below in case of unlawful detention, raids, or any legal emergency. Nearby criminal defense lawyers will be alerted immediately." %}
                </p>
            </div>
            
            <!-- Panic Button -->
            <div class="flex justify-center mb-12">
                <div class="relative">
                    <button id="panic-button" class="panic-button" onclick="triggerPanic()">
                        <span id="button-text" class="flex flex-col items-center gap-1">
                            <span class="text-4xl mb-1">üö®</span>
                            <span class="text-lg font-bold translatable" data-translate="PRESS FOR">{% trans "PRESS FOR" %}</span>
                            <span class="text-2xl font-black translatable" data-translate="HELP">{% trans "HELP" %}</span>
                        </span>
                    </button>
                </div>
            </div>
            
            <!-- Status -->
            <div id="status-container" class="hidden reveal">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl p-8 mb-8 shadow-lg">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <div class="relative">
                            <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                            <div class="absolute inset-0 w-4 h-4 bg-green-500 rounded-full animate-ping"></div>
                        </div>
                        <span class="text-green-700 font-bold text-lg translatable" data-translate="Alert Broadcasted Successfully">{% trans "Alert Broadcasted Successfully" %}</span>
                    </div>
                    <p class="text-green-600 translatable" data-translate="Your location has been shared with nearby criminal defense lawyers. Stay calm, help is on the way.">
                        {% trans "Your location has been shared with nearby criminal defense lawyers. Stay calm, help is on the way." %}
                    </p>
                </div>
                
                <!-- Responder Info -->
                <div id="responder-info" class="hidden">
                    <div class="responder-card bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-accent rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-primary-500/25">
                                üë®‚Äç‚öñÔ∏è
                            </div>
                            <div class="text-left flex-1">
                                <h3 class="font-bold text-gray-900 text-lg" id="responder-name">{% trans "Loading..." %}</h3>
                                <p class="text-gray-500 translatable" data-translate="Criminal Defense Lawyer">{% trans "Criminal Defense Lawyer" %}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-yellow-500">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                    <span class="text-sm text-gray-500 translatable" data-translate="5.0 rating">{% trans "5.0 rating" %}</span>
                                </div>
                            </div>
                            <div class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold translatable" data-translate="RESPONDING">
                                {% trans "RESPONDING" %}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-left mb-6">
                            <div class="bg-gray-50 rounded-xl p-4">
                                <p class="text-sm text-gray-500 mb-1">üìû <span class="translatable" data-translate="Phone">{% trans "Phone" %}</span></p>
                                <p class="font-semibold text-gray-900" id="responder-phone">+91 XXXXXXXXXX</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4">
                                <p class="text-sm text-gray-500 mb-1">‚è±Ô∏è ETA</p>
                                <p class="font-semibold text-gray-900" id="responder-eta">~15 minutes</p>
                            </div>
                        </div>
                        <button class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-green-500/25 transition-all hover:-translate-y-0.5 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                            Call Lawyer Now
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="bg-white/80 backdrop-blur rounded-2xl p-8 text-left mt-10 shadow-lg border border-gray-100 reveal">
                <h3 class="font-bold text-gray-900 mb-6 flex items-center gap-2 text-lg">
                    <span class="w-8 h-8 bg-primary-100 rounded-lg flex items-center justify-center">üìã</span>
                    What happens when you press the button
                </h3>
                <ol class="space-y-4 text-gray-600">
                    <li class="flex items-start gap-4 p-3 bg-gray-50 rounded-xl hover:bg-primary-50 transition-colors">
                        <span class="w-8 h-8 bg-gradient-to-br from-primary-500 to-accent text-white rounded-lg flex items-center justify-center text-sm font-bold flex-shrink-0 shadow-md">1</span>
                        <span class="pt-1">Your current GPS location is captured automatically</span>
                    </li>
                    <li class="flex items-start gap-4 p-3 bg-gray-50 rounded-xl hover:bg-primary-50 transition-colors">
                        <span class="w-8 h-8 bg-gradient-to-br from-primary-500 to-accent text-white rounded-lg flex items-center justify-center text-sm font-bold flex-shrink-0 shadow-md">2</span>
                    <span>An emergency alert is sent to verified criminal defense lawyers within 5km</span>
                </li>
                <li class="flex items-start gap-3">
                    <span class="w-6 h-6 bg-primary-100 text-primary-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">3</span>
                    <span>The first lawyer to respond will be connected to you immediately</span>
                </li>
                <li class="flex items-start gap-3">
                    <span class="w-6 h-6 bg-primary-100 text-primary-700 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">4</span>
                    <span>The responding lawyer receives bonus incentive points for quick response</span>
                </li>
            </ol>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
let emergencySocket = null;
let hasPressed = false;

{% if request.user.is_authenticated %}
function connectEmergencySocket() {
    emergencySocket = new WebSocket(`${wsProtocol}//${window.location.host}/ws/emergency/`);
    
    emergencySocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'emergency_response') {
            showResponder(data);
        }
    };
}

connectEmergencySocket();
{% endif %}

async function triggerPanic() {
    if (hasPressed) return;
    
    {% if not request.user.is_authenticated %}
    alert('Please log in to use the emergency feature');
    window.location.href = '{% url "login" %}?next={% url "emergency_page" %}';
    return;
    {% endif %}
    
    const button = document.getElementById('panic-button');
    const buttonText = document.getElementById('button-text');
    
    // Get location
    buttonText.innerHTML = 'üìç<br>Getting<br>Location...';
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });
        
        const { latitude, longitude } = position.coords;
        
        // Send emergency
        if (emergencySocket && emergencySocket.readyState === WebSocket.OPEN) {
            emergencySocket.send(JSON.stringify({
                action: 'panic',
                latitude: latitude,
                longitude: longitude,
                description: 'Legal Emergency - Immediate assistance needed'
            }));
        }
        
        // Also send to API as backup
        await fetch('{% url "create_emergency" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                latitude: latitude,
                longitude: longitude,
                description: 'Legal Emergency'
            })
        });
        
        hasPressed = true;
        button.classList.add('pressed');
        buttonText.innerHTML = '‚úì<br>ALERT<br>SENT';
        document.getElementById('status-container').classList.remove('hidden');
        
    } catch (error) {
        console.error('Error:', error);
        buttonText.innerHTML = 'üö®<br>PRESS FOR<br>HELP';
        
        if (error.code === 1) {
            alert('Location access denied. Please enable location services.');
        } else {
            alert('Could not get your location. Please try again.');
        }
    }
}

function showResponder(data) {
    document.getElementById('responder-info').classList.remove('hidden');
    document.getElementById('responder-name').textContent = data.responder_name;
    document.getElementById('responder-phone').textContent = data.responder_phone || 'Contact via app';
    document.getElementById('responder-eta').textContent = data.eta || '~15 minutes';
}
</script>
{% endblock %}
